<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Equipos y Resultados</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    textarea {
      width: 400px;
      height: 150px;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      cursor: pointer;
    }
    .resultados {
      margin-top: 20px;
      width: 600px;
      text-align: center;
    }
    .equipo, .partido {
      margin: 10px 0;
      padding: 10px;
      border: 2px solid #444;
      border-radius: 10px;
    }
    .equipo {
      background-color: #f0f0f0;
    }
    .equipo:hover {
      background-color: #d0ffd0;
      cursor: pointer;
    }
    table {
      margin-top: 30px;
      width: 600px;
      border-collapse: collapse;
    }
    table, th, td {
      border: 1px solid black;
    }
    th, td {
      padding: 8px;
      text-align: center;
    }
  </style>
</head>
<body>

  <h1>Generador de Equipos y Resultados</h1>

  <p>Ingresa la lista de jugadores (Nombre, Rol, Tier):</p>
  <textarea id="jugadoresInput" placeholder="Ejemplo:&#10;Juan,Hardcarry,1&#10;Pedro,Off,2&#10;Carlos,Support,3"></textarea>
  
  <br>
  <button onclick="generarEquipos()">Generar Equipos</button>
  <button onclick="limpiarResultados()">Limpiar Resultados</button>
  <button onclick="ordenarTabla('puntos')">Ordenar por Puntos</button>
  <button onclick="ordenarTabla('tier')">Ordenar por Tier</button>
  <button onclick="descargarTabla()">Descargar Tabla</button>

  <div class="resultados" id="resultados"></div>
  <div class="resultados" id="tablaResultados"></div>
  <div class="resultados" id="tablaNoAsignados"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let equiposGlobal = [];
    let jugadoresGlobal = [];
    let partidosGlobal = [];
    let jugadoresNoAsignados = [];

    // Cargar los resultados anteriores si existen
    window.onload = function() {
      if (localStorage.getItem('jugadores')) {
        jugadoresGlobal = JSON.parse(localStorage.getItem('jugadores'));
        equiposGlobal = JSON.parse(localStorage.getItem('equipos'));
        jugadoresNoAsignados = JSON.parse(localStorage.getItem('jugadoresNoAsignados'));
        partidosGlobal = JSON.parse(localStorage.getItem('partidos'));
        mostrarResultados(equiposGlobal, jugadoresNoAsignados);
        actualizarTablaResultados();
        mostrarNoAsignados(jugadoresNoAsignados);
      }
    };

    // Guardar los resultados en localStorage
    function guardarResultados() {
      localStorage.setItem('jugadores', JSON.stringify(jugadoresGlobal));
      localStorage.setItem('equipos', JSON.stringify(equiposGlobal));
      localStorage.setItem('jugadoresNoAsignados', JSON.stringify(jugadoresNoAsignados));
      localStorage.setItem('partidos', JSON.stringify(partidosGlobal));
    }

    // Generar equipos
    function generarEquipos() {
      let texto = document.getElementById('jugadoresInput').value.trim();
      if (!texto) {
        alert("Por favor ingresa jugadores.");
        return;
      }

      let lineas = texto.split('\n');
      let jugadores = [];

      for (let linea of lineas) {
        let partes = linea.split(',');
        if (partes.length !== 3) continue;
        jugadores.push({ nombre: partes[0].trim(), rol: partes[1].trim(), tier: parseInt(partes[2].trim()), puntos: 0 });
      }

      jugadores = jugadores.sort(() => Math.random() - 0.5);

      let hardcarry = jugadores.filter(j => j.rol === "Hardcarry");
      let medio = jugadores.filter(j => j.rol === "Medio");
      let off = jugadores.filter(j => j.rol === "Off");
      let support = jugadores.filter(j => j.rol === "Support");

      let equipos = [];
      let sobrantes = [];

      while (hardcarry.length >= 1 && medio.length >= 1 && off.length >= 1 && support.length >= 2) {
        let equipo = [
          hardcarry.pop(), 
          medio.pop(), 
          off.pop(), 
          support.pop(), 
          support.pop()
        ];
        equipos.push(equipo);
      }

      sobrantes = [...hardcarry, ...medio, ...off, ...support];
      equiposGlobal = equipos;
      jugadoresGlobal = jugadores;
      jugadoresNoAsignados = sobrantes;

      mostrarResultados(equipos, sobrantes);
      actualizarTablaResultados();
      mostrarNoAsignados(sobrantes);

      guardarResultados();
    }

    // Mostrar equipos formados
    function mostrarResultados(equipos, sobrantes) {
      let div = document.getElementById('resultados');
      div.innerHTML = "<h2>Equipos Formados:</h2>";

      equipos.forEach((equipo, idx) => {
        div.innerHTML += `<div class="equipo"><strong>Equipo ${idx + 1}:</strong><br>${equipo.map(j => j.nombre + " (" + j.rol + ", T" + j.tier + ")").join(", ")}</div>`;
      });

      div.innerHTML += "<h2>Partidos:</h2>";

      for (let i = 0; i < equipos.length; i += 2) {
        if (i + 1 < equipos.length) {
          let partidoId = partidosGlobal.length;
          partidosGlobal.push({ equipoA: i, equipoB: i + 1, ganador: null });
          div.innerHTML += `<div class="partido" id="partido${partidoId}">
            <div onclick="seleccionarGanador(${partidoId}, 'A')"><strong>Equipo ${i + 1}</strong></div>
            VS
            <div onclick="seleccionarGanador(${partidoId}, 'B')"><strong>Equipo ${i + 2}</strong></div>
          </div>`;
        }
      }
    }

    // Seleccionar ganador y actualizar puntos
    function seleccionarGanador(partidoId, equipoGanador) {
      let partido = partidosGlobal[partidoId];
      if (partido.ganador !== null) {
        alert("Ya seleccionaste un ganador para este partido.");
        return;
      }
      partido.ganador = equipoGanador;

      let equipoA = equiposGlobal[partido.equipoA];
      let equipoB = equiposGlobal[partido.equipoB];

      if (equipoGanador === 'A') {
        equipoA.forEach(j => j.puntos += 2);
        equipoB.forEach(j => j.puntos -= 1);
      } else {
        equipoB.forEach(j => j.puntos += 2);
        equipoA.forEach(j => j.puntos -= 1);
      }

      document.getElementById(`partido${partidoId}`).style.backgroundColor = "#d0ffd0";
      actualizarTablaResultados();
      guardarResultados();
    }

    // Actualizar tabla de resultados
    function actualizarTablaResultados() {
      let div = document.getElementById('tablaResultados');
      div.innerHTML = "<h2>Tabla de Resultados:</h2>";

      let tabla = `<table><tr><th>Nombre</th><th>Rol</th><th>Tier</th><th>Puntos</th></tr>`;
      jugadoresGlobal.forEach(j => {
        tabla += `<tr><td>${j.nombre}</td><td>${j.rol}</td><td>${j.tier}</td><td>${j.puntos}</td></tr>`;
      });
      tabla += `</table>`;

      div.innerHTML += tabla;
    }

    // Mostrar jugadores no asignados
    function mostrarNoAsignados(sobrantes) {
      let div = document.getElementById('tablaNoAsignados');
      div.innerHTML = "<h2>Jugadores No Asignados:</h2>";

      if (sobrantes.length === 0) {
        div.innerHTML += "No hay jugadores sobrantes.";
        return;
      }

      let tabla = `<table><tr><th>Nombre</th><th>Rol</th><th>Tier</th></tr>`;
      sobrantes.forEach(j => {
        tabla += `<tr><td>${j.nombre}</td><td>${j.rol}</td><td>${j.tier}</td></tr>`;
      });
      tabla += `</table>`;

      div.innerHTML += tabla;
    }

    // Ordenar la tabla
    function ordenarTabla(criterio) {
      if (criterio === 'puntos') {
        jugadoresGlobal.sort((a, b) => b.puntos - a.puntos);
      } else if (criterio === 'tier') {
        jugadoresGlobal.sort((a, b) => a.tier - b.tier);
      }
      actualizarTablaResultados();
    }

    // Descargar la tabla en formato Excel
    function descargarTabla() {
      let wb = XLSX.utils.book_new();
      let data = [];

      jugadoresGlobal.forEach(jugador => {
        data.push([jugador.nombre, jugador.rol, `Tier ${jugador.tier}`, `Puntos ${jugador.puntos}`]);
      });

      let ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, "Equipos y Resultados");
      XLSX.writeFile(wb, "equipos_resultados.xlsx");
    }

    // Limpiar resultados
    function limpiarResultados() {
      document.getElementById('jugadoresInput').value = "";
      document.getElementById('resultados').innerHTML = "";
      document.getElementById('tablaResultados').innerHTML = "";
      document.getElementById('tablaNoAsignados').innerHTML = "";
      localStorage.clear();
    }
  </script>

</body>
</html>
