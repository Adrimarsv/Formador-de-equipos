<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formador de Equipos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    textarea {
      width: 400px;
      height: 150px;
    }
    button {
      margin: 5px;
      padding: 10px 20px;
      cursor: pointer;
    }
    .resultados {
      margin-top: 20px;
      width: 600px;
      text-align: center;
    }
    .equipo, .partido {
      margin: 10px 0;
      padding: 10px;
      border: 2px solid #444;
      border-radius: 10px;
    }
    .equipo {
      background-color: #f0f0f0;
    }
    .equipo:hover {
      background-color: #d0ffd0;
      cursor: pointer;
    }
    table {
      margin-top: 30px;
      width: 600px;
      border-collapse: collapse;
    }
    table, th, td {
      border: 1px solid black;
    }
    th, td {
      padding: 8px;
      text-align: center;
    }
  </style>
</head>
<body>

  <h1>Generador de Equipos y Partidos</h1>

  <p>Ingresa la lista de jugadores (Nombre, Tier):</p>
  <textarea id="jugadoresInput" placeholder="Ejemplo:&#10;Jugador1,1&#10;Jugador2,2&#10;Jugador3,3"></textarea>
  
  <br>
  <button onclick="generarEquipos()">Generar Equipos</button>
  <button onclick="ordenarPorPuntos()">Ordenar por Puntos</button>
  <button onclick="exportarExcel()">Descargar Excel Equipos</button>
  <button onclick="descargarTabla()">Descargar Tabla de Jugadores</button>
  <button onclick="limpiarTabla()">Limpiar Tabla</button>

  <div class="resultados" id="resultados"></div>

  <div class="resultados" id="tablaResultados"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let equiposGlobal = [];
    let jugadoresGlobal = [];
    let partidosGlobal = [];

    window.onload = function() {
      let jugadoresGuardados = localStorage.getItem('jugadoresGlobal');
      if (jugadoresGuardados) {
        jugadoresGlobal = JSON.parse(jugadoresGuardados);
        actualizarTablaResultados();
      }
    };

    function guardarJugadoresEnLocalStorage() {
      localStorage.setItem('jugadoresGlobal', JSON.stringify(jugadoresGlobal));
    }

    function generarEquipos() {
      let texto = document.getElementById('jugadoresInput').value.trim();
      if (!texto) {
        alert("Por favor ingresa jugadores.");
        return;
      }

      let lineas = texto.split('\n');
      let nuevosJugadores = [];

      for (let linea of lineas) {
        let partes = linea.split(',');
        if (partes.length !== 2) continue;
        nuevosJugadores.push({ nombre: partes[0].trim(), tier: parseInt(partes[1].trim()), puntos: 0 });
      }

      for (let nuevo of nuevosJugadores) {
        let existente = jugadoresGlobal.find(j => j.nombre === nuevo.nombre);
        if (!existente) {
          jugadoresGlobal.push(nuevo);
        }
      }

      jugadoresGlobal = jugadoresGlobal.sort(() => Math.random() - 0.5);

      let tier1 = jugadoresGlobal.filter(j => j.tier === 1);
      let tier2 = jugadoresGlobal.filter(j => j.tier === 2);
      let tier3 = jugadoresGlobal.filter(j => j.tier === 3);

      equiposGlobal = [];
      partidosGlobal = [];
      let sobrantes = [];

      while (tier1.length >= 1 && tier2.length >= 2 && tier3.length >= 2) {
        let equipo = [tier1.pop(), tier2.pop(), tier2.pop(), tier3.pop(), tier3.pop()];
        equiposGlobal.push(equipo);
      }

      sobrantes = [...tier1, ...tier2, ...tier3];

      mostrarResultados(equiposGlobal, sobrantes);
      actualizarTablaResultados();
      guardarJugadoresEnLocalStorage();
    }

    function mostrarResultados(equipos, sobrantes) {
      let div = document.getElementById('resultados');
      div.innerHTML = "<h2>Equipos Formados:</h2>";

      equipos.forEach((equipo, idx) => {
        div.innerHTML += `<div class="equipo"><strong>Equipo ${idx + 1}:</strong><br>${equipo.map(j => j.nombre + " (T" + j.tier + ")").join(", ")}</div>`;
      });

      div.innerHTML += "<h2>Partidos:</h2>";

      for (let i = 0; i < equipos.length; i += 2) {
        if (i + 1 < equipos.length) {
          let partidoId = partidosGlobal.length;
          partidosGlobal.push({ equipoA: i, equipoB: i+1, ganador: null });
          div.innerHTML += `<div class="partido" id="partido${partidoId}">
            <div onclick="seleccionarGanador(${partidoId}, 'A')"><strong>Equipo ${i+1}</strong></div>
            VS
            <div onclick="seleccionarGanador(${partidoId}, 'B')"><strong>Equipo ${i+2}</strong></div>
          </div>`;
        }
      }

      if (sobrantes.length > 0) {
        div.innerHTML += "<h2>Jugadores sobrantes:</h2>";
        div.innerHTML += sobrantes.map(j => j.nombre + " (T" + j.tier + ")").join(", ") + "<br>";
      }
    }

    function seleccionarGanador(partidoId, equipoGanador) {
      let partido = partidosGlobal[partidoId];
      if (partido.ganador !== null) {
        alert("Ya seleccionaste un ganador para este partido.");
        return;
      }
      partido.ganador = equipoGanador;

      let equipoA = equiposGlobal[partido.equipoA];
      let equipoB = equiposGlobal[partido.equipoB];

      if (equipoGanador === 'A') {
        equipoA.forEach(j => j.puntos += 2);
        equipoB.forEach(j => j.puntos -= 1);
      } else {
        equipoB.forEach(j => j.puntos += 2);
        equipoA.forEach(j => j.puntos -= 1);
      }

      document.getElementById(`partido${partidoId}`).style.backgroundColor = "#d0ffd0";

      actualizarTablaResultados();
      guardarJugadoresEnLocalStorage();
    }

    function actualizarTablaResultados() {
      let div = document.getElementById('tablaResultados');
      div.innerHTML = "<h2>Tabla de Resultados:</h2>";

      let tabla = `<table><tr><th>Nombre</th><th>Tier</th><th>Puntos</th></tr>`;
      jugadoresGlobal.forEach(j => {
        tabla += `<tr><td>${j.nombre}</td><td>${j.tier}</td><td>${j.puntos}</td></tr>`;
      });
      tabla += `</table>`;

      div.innerHTML += tabla;
    }

    function exportarExcel() {
      if (equiposGlobal.length === 0) {
        alert("Primero genera equipos.");
        return;
      }

      let wb = XLSX.utils.book_new();
      let data = [];

      equiposGlobal.forEach((equipo, idx) => {
        data.push([`Equipo ${idx + 1}`]);
        equipo.forEach(jugador => {
          data.push([jugador.nombre, `Tier ${jugador.tier}`, `Puntos ${jugador.puntos}`]);
        });
        data.push([]);
      });

      let ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, "Equipos y Resultados");
      XLSX.writeFile(wb, "equipos_resultados.xlsx");
    }

    function descargarTabla() {
      if (jugadoresGlobal.length === 0) {
        alert("No hay jugadores para exportar.");
        return;
      }

      let wb = XLSX.utils.book_new();
      let data = [["Nombre", "Tier", "Puntos"]];

      jugadoresGlobal.forEach(jugador => {
        data.push([jugador.nombre, jugador.tier, jugador.puntos]);
      });

      let ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, "Jugadores");
      XLSX.writeFile(wb, "jugadores_puntos.xlsx");
    }

    function limpiarTabla() {
      if (confirm("¿Seguro que quieres borrar todo? Esta acción no se puede deshacer.")) {
        jugadoresGlobal = [];
        equiposGlobal = [];
        partidosGlobal = [];
        localStorage.clear();
        document.getElementById('jugadoresInput').value = "";
        document.getElementById('resultados').innerHTML = "";
        document.getElementById('tablaResultados').innerHTML = "";
        alert("Tabla limpiada correctamente.");
      }
    }

    function ordenarPorPuntos() {
      jugadoresGlobal.sort((a, b) => b.puntos - a.puntos);
      actualizarTablaResultados();
    }

  </script>

</body>
</html>
