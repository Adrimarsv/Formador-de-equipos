<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formador de Equipos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    textarea {
      width: 400px;
      height: 150px;
    }
    button {
      margin: 5px;
      padding: 10px 20px;
      cursor: pointer;
    }
    .resultados {
      margin-top: 20px;
      width: 600px;
      text-align: center;
    }
    .equipo, .partido {
      margin: 10px 0;
      padding: 10px;
      border: 2px solid #444;
      border-radius: 10px;
    }
    .equipo {
      background-color: #f0f0f0;
    }
    .equipo:hover {
      background-color: #d0ffd0;
      cursor: pointer;
    }
    table {
      margin-top: 30px;
      width: 600px;
      border-collapse: collapse;
    }
    table, th, td {
      border: 1px solid black;
    }
    th, td {
      padding: 8px;
      text-align: center;
    }
  </style>
</head>
<body>

  <h1>Generador de Equipos y Partidos</h1>

  <p>Ingresa la lista de jugadores (Nombre, Tier):</p>
  <textarea id="jugadoresInput" placeholder="Ejemplo:&#10;Jugador1,1&#10;Jugador2,2&#10;Jugador3,3"></textarea>
  
  <br>
  <button onclick="generarEquipos()">Generar Equipos</button>
  <button onclick="ordenarPorPuntos()">Ordenar por Puntos</button>
  <button onclick="ordenarPorTier()">Ordenar por Tier</button>
  <button onclick="limpiarTabla()">Limpiar Tabla</button>
  <button onclick="descargarTabla()">Descargar Tabla (Excel)</button>
  <br><br>
  <input type="file" id="fileInput" onchange="cargarTablaDesdeExcel()" />

  <div class="resultados" id="resultados"></div>

  <div class="resultados" id="tablaResultados"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let equiposGlobal = [];
    let jugadoresGlobal = JSON.parse(localStorage.getItem('jugadores')) || [];
    let partidosGlobal = [];

    function guardarEnLocalStorage() {
      localStorage.setItem('jugadores', JSON.stringify(jugadoresGlobal));
    }

    function generarEquipos() {
      let texto = document.getElementById('jugadoresInput').value.trim();
      if (!texto) {
        alert("Por favor ingresa jugadores.");
        return;
      }

      let lineas = texto.split('\n');
      for (let linea of lineas) {
        let partes = linea.split(',');
        if (partes.length !== 2) continue;
        let nombre = partes[0].trim();
        let tier = parseInt(partes[1].trim());
        if (!jugadoresGlobal.find(j => j.nombre === nombre)) {
          jugadoresGlobal.push({ nombre, tier, puntos: 0 });
        }
      }

      guardarEnLocalStorage();
      jugadoresGlobal = jugadoresGlobal.sort(() => Math.random() - 0.5);

      let tier1 = jugadoresGlobal.filter(j => j.tier === 1);
      let tier2 = jugadoresGlobal.filter(j => j.tier === 2);
      let tier3 = jugadoresGlobal.filter(j => j.tier === 3);

      let equipos = [];
      let sobrantes = [];

      while (tier1.length >= 1 && tier2.length >= 2 && tier3.length >= 2) {
        let equipo = [tier1.pop(), tier2.pop(), tier2.pop(), tier3.pop(), tier3.pop()];
        equipos.push(equipo);
      }

      sobrantes = [...tier1, ...tier2, ...tier3];
      equiposGlobal = equipos;
      partidosGlobal = [];

      mostrarResultados(equipos, sobrantes);
      actualizarTablaResultados();
    }

    function mostrarResultados(equipos, sobrantes) {
      let div = document.getElementById('resultados');
      div.innerHTML = "<h2>Equipos Formados:</h2>";

      equipos.forEach((equipo, idx) => {
        div.innerHTML += `<div class="equipo"><strong>Equipo ${idx + 1}:</strong><br>${equipo.map(j => j.nombre + " (T" + j.tier + ")").join(", ")}</div>`;
      });

      div.innerHTML += "<h2>Partidos:</h2>";

      for (let i = 0; i < equipos.length; i += 2) {
        if (i + 1 < equipos.length) {
          let partidoId = partidosGlobal.length;
          partidosGlobal.push({ equipoA: i, equipoB: i+1, ganador: null });
          div.innerHTML += `<div class="partido" id="partido${partidoId}">
            <div onclick="seleccionarGanador(${partidoId}, 'A')"><strong>Equipo ${i+1}</strong></div>
            VS
            <div onclick="seleccionarGanador(${partidoId}, 'B')"><strong>Equipo ${i+2}</strong></div>
          </div>`;
        }
      }

      if (sobrantes.length > 0) {
        div.innerHTML += "<h2>Jugadores sobrantes:</h2>";
        div.innerHTML += sobrantes.map(j => j.nombre + " (T" + j.tier + ")").join(", ") + "<br>";
      }
    }

    function seleccionarGanador(partidoId, equipoGanador) {
      let partido = partidosGlobal[partidoId];
      if (partido.ganador !== null) {
        alert("Ya seleccionaste un ganador para este partido.");
        return;
      }
      partido.ganador = equipoGanador;

      let equipoA = equiposGlobal[partido.equipoA];
      let equipoB = equiposGlobal[partido.equipoB];

      if (equipoGanador === 'A') {
        equipoA.forEach(j => j.puntos += 2);
        equipoB.forEach(j => j.puntos -= 1);
      } else {
        equipoB.forEach(j => j.puntos += 2);
        equipoA.forEach(j => j.puntos -= 1);
      }

      guardarEnLocalStorage();
      document.getElementById(`partido${partidoId}`).style.backgroundColor = "#d0ffd0";
      actualizarTablaResultados();
    }

    function actualizarTablaResultados() {
      let div = document.getElementById('tablaResultados');
      div.innerHTML = "<h2>Tabla de Resultados:</h2>";

      let tabla = `<table><tr><th>Nombre</th><th>Tier</th><th>Puntos</th></tr>`;
      jugadoresGlobal.forEach(j => {
        tabla += `<tr><td>${j.nombre}</td><td>${j.tier}</td><td>${j.puntos}</td></tr>`;
      });
      tabla += `</table>`;

      div.innerHTML += tabla;
    }

    function ordenarPorPuntos() {
      jugadoresGlobal.sort((a, b) => b.puntos - a.puntos);
      actualizarTablaResultados();
    }

    function ordenarPorTier() {
      jugadoresGlobal.sort((a, b) => a.tier - b.tier);
      actualizarTablaResultados();
    }

    function limpiarTabla() {
      if (confirm("¿Estás seguro de limpiar toda la tabla?")) {
        jugadoresGlobal = [];
        localStorage.removeItem('jugadores');
        actualizarTablaResultados();
      }
    }

    function descargarTabla() {
      if (jugadoresGlobal.length === 0) {
        alert("No hay datos para descargar.");
        return;
      }
      let wb = XLSX.utils.book_new();
      let data = [["Nombre", "Tier", "Puntos"]];
      jugadoresGlobal.forEach(j => {
        data.push([j.nombre, j.tier, j.puntos]);
      });
      let ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, "Tabla");
      XLSX.writeFile(wb, "tabla_jugadores.xlsx");
    }

    function cargarTablaDesdeExcel() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        json.shift(); // eliminar encabezado
        json.forEach(row => {
          if (row.length >= 3) {
            const nombre = row[0];
            const tier = parseInt(row[1]);
            const puntos = parseInt(row[2]);

            const jugadorExistente = jugadoresGlobal.find(j => j.nombre === nombre);
            if (jugadorExistente) {
              jugadorExistente.tier = tier;
              jugadorExistente.puntos = puntos;
            } else {
              jugadoresGlobal.push({ nombre, tier, puntos });
            }
          }
        });

        guardarEnLocalStorage();
        actualizarTablaResultados();
      };
      reader.readAsArrayBuffer(file);
    }

    // Cargar al iniciar
    actualizarTablaResultados();
  </script>

</body>
</html>
